---
layout: post
title: "如何在React元件中使用d3圖表"
---

最近試著在React的專案中使用d3。但是兩套library的開發思維不太一樣。

這篇來分享一下自己在React元件中使用d3圖表的心得。

# 範例

今天的範例是，在React元件裡面顯示d3長條圖。

* 每根長條都是一個svg的rect元素，用高度來表示資料的大小。
* 按下"Add"會在圖表右側新增一筆資料（隨機值），按下"Remove"會移除圖表最左側的一筆資料。

範例如下：

<p data-height="328" data-theme-id="0" data-slug-hash="pbdGYX" data-default-tab="result" data-user="shubochao" data-embed-version="2" class="codepen">See the Pen <a href="http://codepen.io/shubochao/pen/pbdGYX/">react-d3-lifecycle-example</a> by Shubo Chao (<a href="http://codepen.io/shubochao">@shubochao</a>) on <a href="http://codepen.io">CodePen</a>.</p>
<script async src="//assets.codepen.io/assets/embed/ei.js"></script>

# d3簡介

d3是一個做資料視覺化的函式庫，方便使用者將svg圖形組合成資訊圖表。[D3 Gallery](https://github.com/d3/d3/wiki/Gallery)可以看到許多華麗的範例。

d3的幾個重點：

* Data binding
* enter(), exit()

## Data Binding

Data Binding讓資料和DOM節點形成一對一的對應關係，當資料改變時，可以方便對DOM節點做更新。

假設我們有以下的資料格式要做成長條圖：

<pre><code class="language-javascript">
let dataset = [ 
    { key: 0, value: 5 },
    { key: 1, value: 10 },
    { key: 2, value: 13 },
    ...
];
</code></pre>

d3提供了一些方便操作DOM節點的方法。

* d3.select() 和 d3.selectAll()：用來選擇DOM節點。(類似jQuery的$(selector))
* d3.append()：插入DOM節點。

利用select和append新增一個svg元素：

<pre><code class="language-javascript">
let svg = d3.select('body') // 在body裡面插入svg元素
            .append('svg')
            .attr('width', w)
            .attr('height', h);
</code></pre>

* d3.data()：將每一筆資料都綁定一個DOM節點。當某筆資料需要更新的時候，就可以知道這筆資料對應到哪一個DOM節點。綁定的方式是對每筆資料d，回傳唯一的key值。

將dataset中每筆資料d都綁定到一個rect元素，key是d.key：

<pre><code class="language-javascript">
let bars = svg.selectAll('rect').data(dataset, d => d.key);
</code></pre>

## Enter, Update and Exit

### Update

我們可以根據資料大小，設定長條圖的x, y座標和長寬：

<pre><code class="language-javascript">
// Update
bars.attr('x', (d, i) => xScale(i))
    .attr('width', xScale.rangeBand())
    .attr('y', d => yScale(d.value))
    .attr('height', d => h - yScale(d.value)); // 高度正比於資料大小
</code></pre>

當資料值改變，需要更新長條圖時，也是這麼做的。

### Enter

當新增了幾筆資料時，要怎麼更新現有的圖表呢？

* enter()：當存在尚未綁定DOM節點的資料時，篩選出這些“尚未存在的DOM節點”。使用append()可以對每筆資料產生對應的DOM節點，並把資料和DOM節點綁定在一起。

替新增的資料產生相對應的rect節點：

<pre><code class="language-javascript">
// Enter
bars.enter()
    .append('rect') // 新增rect元素
    .attr('x', w) // 設定座標，長寬...
    .attr('width', xScale.rangeBand())
    .attr('y', d => yScale(d.value))
    .attr('height', d => h - yScale(d.value));
</code></pre>    

### Exit

那如果有幾筆資料已經不存在時，要如何更新現有的圖表？

* exit()：篩選出“已經不存在相對應資料的DOM節點“。

對這些節點使用remove()即可從畫面中移除這些DOM節點。

<pre><code class="language-javascript">
// Exit
bars.exit().remove();
</code></pre>

# d3 render()

<pre><code class="language-javascript">
const render = () => {
  let xScale = d3.scale.ordinal()
    .domain(d3.range(dataset.length))
    .rangeRoundBands([0, w], 0.05);
  let yScale = d3.scale.linear()
    .domain([0, d3.max(dataset, d => d.value)])
    .range([h, 0]);

  // Data binding with key
  let bars = svg.selectAll('rect').data(dataset, d => d.key);

  // Enter
  bars.enter()
    .append('rect')
    .classed("bar", true)
    .attr('x', w) // Enter from the right side
    .attr('width', xScale.rangeBand())
    .attr('y', d => yScale(d.value))
    .attr('height', d => h - yScale(d.value));

  // Update
  bars.transition()
    .duration(500)
    .attr('x', (d, i) => xScale(i))
    .attr('width', xScale.rangeBand())
    .attr('y', d => yScale(d.value))
    .attr('height', d => h - yScale(d.value));
  
  // Exit
  bars.exit()
    .transition()
    .duration(500)
    .attr("x", -xScale.rangeBand()) // Exit to the left side
    .remove();
}
</code></pre>

# React和d3有何不同

d3讓使用者直接去操作/修改DOM元件，達到改變ＵＩ外觀的目的。

React開發的中心思想是：當需要改變ＵＩ外觀的時候，使用者不直接操作/修改DOM元件，而是改變元件的state，間接觸發render()去根據最新的state重繪ＵＩ。

# React提供的機制

React提供接口(componentDidMount, componentDidUpdate)，讓你在生命週期的某些階段可以安全操作你的DOM。React也提供refs，讓你可以直接存取某個節點的DOM

(refs? 虛擬DOM? 實體DOM?)

# 做法

想法：把dataset記錄在React的state裡，用一個DOM node當作d3圖表的根節點，每次dataset改變時去更新圖表所在的節點

有兩個按鈕，按了之後會更新this.state.dataset，觸發React重新render。


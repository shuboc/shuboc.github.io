---
title: "[æ•™å­¸] JavaScript Closure (é–‰åŒ…)ã€å‡½å¼èˆ‡èªå½™ç’°å¢ƒ"
tags: ["javascript"]
redirect_from: /2018/03/04/javascript-closure-in-depth
last_modified_at: 2020/07/15
---

é–‰åŒ… (Closure) æ˜¯å‡½å¼ä»¥åŠå…¶èªå½™ç’°å¢ƒ (lexical environment) çš„çµ„åˆï¼Œå‡½å¼èƒ½å¤ è¨˜ä½è¢«å‰µé€ çš„ç•¶ä¸‹çš„ç’°å¢ƒä»¥åŠè®Šæ•¸ã€‚äº‹å¯¦ä¸Š closure æ˜¯ JavaScript ä¸­æœ€é‡è¦å»åˆä¸æ˜“ç†è§£çš„æ¦‚å¿µä¹‹ä¸€ï¼Œä¸¦ä¸”æœ‰è¨±å¤šå¯¦éš›æ‡‰ç”¨ï¼Œä¾‹å¦‚IIFEã€æ¨¡æ“¬ private member é”åˆ°å°è£çš„ç‰¹æ€§ (module pattern) ç­‰ï¼Œé€™ç¯‡æ–‡ç« å°‡æœƒä¸€ä¸€ä»‹ç´¹ç¯„ä¾‹ã€‚

<!-- ![JavaScript Closure](/images/javascript-closure.jpg) -->

## é–‰åŒ… (Closure) æ˜¯ä»€éº¼ï¼Ÿ

è¦æˆ‘ç”¨ä¸€å¥è©±è§£é‡‹ closure çš„è©±ï¼Œå°±æ˜¯ï¼š**é–‰åŒ… (Closure) æ˜¯ä¸€å€‹å‡½å¼ï¼Œä»–èƒ½å¤ å­˜å–è¢«å®£å‘Šç•¶ä¸‹çš„ç’°å¢ƒä¸­çš„è®Šæ•¸ã€‚**

[MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures)ä¸Šå° closure æ¯”è¼ƒæ­£å¼çš„å®šç¾©æ˜¯ï¼š

> A closure is the combination of a function and the Lexical Environment within which that function was declared.

ç¿»è­¯æˆä¸­æ–‡å°±æ˜¯ï¼šclosure æ˜¯ä¸€å€‹å‡½æ•¸å’Œæ­¤å‡½æ•¸è¢«å®£å‘Šæ™‚æ‰€åœ¨çš„èªå½™ç’°å¢ƒã€‚

è®“æˆ‘ä¾†ç‚ºå¤§å®¶ç¿»è­¯ä¸€ä¸‹ï¼Œé€™å¥è©±çš„æ„æ€æ˜¯ï¼š

Closure æ˜¯ç”±å…©å€‹ä¸»è§’æ§‹æˆçš„ä¸€å€‹çµ„åˆï¼Œåˆ†åˆ¥æ˜¯ï¼š

1. å‡½å¼ (function)
2. å‡½å¼è¢«å®£å‘Šæ™‚æ‰€åœ¨çš„èªå½™ç’°å¢ƒ (lexical environment)ã€‚

ç°¡å–®åœ°èªªï¼Œclosure åŒ…å«äº†ä¸€å€‹å‡½å¼ï¼Œé€™å€‹å‡½å¼æœƒå°æ‡‰åˆ°ä¸€å€‹ lexical environment (èªå½™ç’°å¢ƒ)ã€‚

æ‰€è¬‚çš„ã€Œèªå½™ç’°å¢ƒã€ï¼Œå¯ä»¥ç°¡å–®åœ°æƒ³åƒæˆæ˜¯å‡½å¼è¢«å®£å‘Šæ™‚æ‰€åœ¨çš„ scopeï¼Œé€™å€‹ scope è£¡é¢åŒ…å«äº†èƒ½å¤ è¢«é€™å€‹å‡½å¼å­˜å–åˆ°çš„è®Šæ•¸ã€‚

ç‚ºäº†æ–¹ä¾¿ç†è§£å’Œè¨˜æ†¶ï¼Œä½ å¯ä»¥æŠŠ closure æƒ³æˆæ˜¯**ä¸€å€‹å‡½å¼ï¼Œå®ƒèƒ½å¤ å­˜å–è‡ªå·±è¢«å®£å‘Šæ™‚çš„ç’°å¢ƒä¸­çš„è®Šæ•¸ã€‚**

åˆ°é€™é‚Šæˆ–è¨±æœƒæœ‰é»é›£ç†è§£ï¼Œä½†æ˜¯åˆ¥æ“”å¿ƒï¼ä¸‹é¢æˆ‘æœƒç”¨ä¸€äº›å¾ˆç°¡å–®çš„ä¾‹å­èªªæ˜ closure çš„ç‰¹æ€§ï¼Œä¹‹å¾Œå†å›é ­çœ‹é€™æ®µçš„è©±ï¼Œæ‡‰è©²æœƒæ¯”è¼ƒæœ‰æ„Ÿè¦ºï¼

è®“æˆ‘å€‘ç¹¼çºŒçœ‹ä¸‹å»ï¼

### JavaScript çš„è®Šæ•¸å­˜å–è¦å‰‡

è¦ç†è§£ closureï¼Œé¦–å…ˆæˆ‘å€‘è¦è«‡è«‡ JavaScript ä¸­ï¼Œé—œæ–¼**è®Šæ•¸å­˜å–çš„è¦å‰‡**ã€‚

ä¸‹é¢ç›´æ¥èˆ‰ä¸€æ®µç¨‹å¼ç¢¼ç•¶ä½œä¾‹å­ï¼š

```Javascript
function sayHi() {
  let name = "John"; // (1)
  function displayName() { // (2)
    console.log(name);
  }
  displayName();
}

sayHi();
```

é¦–å…ˆï¼Œæˆ‘å€‘å®£å‘Šä¸€å€‹å‡½å¼ `sayHi()`ï¼Œåœ¨è£¡é ­å®£å‘Šäº†ä¸€å€‹è®Šæ•¸ `name` (1) å’Œä¸€å€‹å‡½å¼ `displayName()` (2)ï¼Œ`displayName()` å…§éƒ¨æœƒç”¨åˆ° `name` é€™å€‹è®Šæ•¸ã€‚æœ€å¾Œæˆ‘å€‘å‘¼å« `sayHi()`ã€‚

å•é¡Œä¾†å›‰ï¼š

> è®Šæ•¸ `name` ä¸¦ä¸æ˜¯å®£å‘Šåœ¨ `displayName()` å…§ï¼Œè€Œæ˜¯å®£å‘Šåœ¨ä»–çš„å¤–éƒ¨ç’°å¢ƒ `init()`ã€‚
> è«‹å•é€™ç¨®æƒ…æ³ä¸‹ `console.log(name)` æœƒå°å‡ºä»€éº¼å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ `"John"`ã€‚ç‚ºä»€éº¼å‘¢ï¼Ÿ

å› ç‚º JavaScript çš„è®Šæ•¸å°‹æ‰¾è¦å‰‡æ˜¯ï¼š

> **å…§å±¤å€å¡Šå¯ä»¥å­˜å–å®šç¾©åœ¨å¤–å±¤å€å¡Šçš„è®Šæ•¸ã€‚åéä¾†èªªï¼Œå¤–å±¤å€å¡Šæ²’è¾¦æ³•å­˜å–å…§å±¤å€å¡Šçš„è®Šæ•¸ã€‚**

æ‰€ä»¥å…§å±¤å€å¡Š `displayName()` å¯ä»¥å­˜å–å®šç¾©åœ¨å¤–å±¤å€å¡Š `init()` çš„è®Šæ•¸ `name`ã€‚

> é€™æ¨£çš„è®Šæ•¸æŸ¥æ‰¾è¦å‰‡ï¼Œæœ‰å€‹å°ˆæœ‰åè©å«åš *Lexical Scoping*ã€‚å¤§éƒ¨åˆ†çš„ç¨‹å¼èªè¨€éƒ½æ¡ç”¨é¡ä¼¼çš„è®Šæ•¸æŸ¥æ‰¾è¦å‰‡ï¼Œå¦å¤–æœ‰ä¸€ç¨® *Dynamic Scoping* çš„è¦å‰‡ï¼Œä½†æˆ‘å°±æ²’è©³ç´°ç ”ç©¶å›‰ï¼Œå¤§å®¶æœ‰èˆˆè¶£å¯ä»¥çœ‹çœ‹é€™ç¯‡é—œæ–¼[Lexical Scopingçš„ä»‹ç´¹](https://stackoverflow.com/questions/1047454/what-is-lexical-scope)ã€‚

æˆ–è¨±ä½ æœƒè¦ºå¾—ï¼Œé€™ä»¶äº‹ä¸æ˜¯ç†æ‰€ç•¶ç„¶çš„å—ï¼Ÿ

å…ˆåˆ¥æ€¥ï¼Œè®“æˆ‘å€‘è€å¿ƒçœ‹ä¸‹å»ï¼ğŸ‘‡

### å‡½å¼å¯ä»¥ç•¶ä½œå¦ä¸€å€‹å‡½å¼çš„å›å‚³å€¼

JavaScript çš„å¦ä¸€å€‹ç‰¹è‰²æ˜¯ï¼šå‡½å¼åœ¨ JavaScript ä¸­æ˜¯[ä¸€ç­‰å…¬æ°‘ (first-class)](https://developer.mozilla.org/en-US/docs/Glossary/First-class_Function)ã€‚

é€™æ˜¯ä»€éº¼æ„æ€å‘¢ï¼Ÿç™½è©±æ–‡çš„è§£é‡‹å°±æ˜¯åœ¨ JavaScript ä¸­ï¼Œå‡½å¼æ˜¯ä¸€ç¨®ç‰©ä»¶ã€‚

**å› ç‚ºå‡½å¼æ˜¯ç‰©ä»¶ï¼Œæ‰€ä»¥å‡½å¼ä¸åƒ…å¯ä»¥ä½œç‚ºå‡½å¼çš„åƒæ•¸ï¼Œä¹Ÿå¯ä»¥ç•¶ä½œå‡½å¼çš„å›å‚³å€¼ã€‚**

ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘å€‘æŠŠ `sayHi` ç•¶æˆæ˜¯å‡½æ•¸çš„å›å‚³å€¼ (1)ï¼š

```JavaScript
function makeSayHi() {
  function sayHi() {
    console.log("John");
  }
  return sayHi; // (1)
}

const sayHi = makeSayHi(); // (2)
sayHi(); // John
```

ç•¶æˆ‘å€‘å‘¼å« `makeSayHi()`ï¼Œå°±æœƒå›å‚³ä¸€å€‹å¯ä»¥è¢«å‘¼å«çš„å‡½å¼ (2)ã€‚

ä½ å¯èƒ½æœƒå•ï¼Œå‡½å¼å¯ä»¥ç•¶ä½œå›å‚³å€¼ï¼Œé‚£åˆæ€æ¨£ï¼Ÿå…¶å¯¦é€™å€‹ç‰¹æ€§æœƒè·Ÿä¸‹ä¸€å€‹è¦æåˆ°çš„ç‰¹æ€§æœ‰é—œã€‚

è®“æˆ‘å€‘å¾€ä¸‹çœ‹ï¼

### Closure å¯ä»¥ã€Œä¿ç•™ã€ç’°å¢ƒ

ç¬¬ä¸‰å€‹ç‰¹æ€§æ˜¯ï¼šé–‰åŒ… (closure) å¯ä»¥ã€Œä¿ç•™ã€ç’°å¢ƒã€‚é€™å€‹ç‰¹æ€§æœƒç”¨åˆ°å‰é¢æéçš„å…©å€‹ç‰¹æ€§ï¼šå‡½å¼å¯ä»¥å­˜å–å¤–å±¤è®Šæ•¸ï¼Œä»¥åŠå‡½å¼å¯ä»¥ä½œç‚ºå›å‚³å€¼ã€‚

æˆ‘ç”¨ä¸‹é¢é€™å€‹ä¾‹å­ä¾†èªªæ˜ï¼š

1. é¦–å…ˆå®šç¾©ä¸€å€‹å‡½å¼ `makeFunc()`ã€‚
2. `makeFunc()` è£¡é¢å®šç¾©äº†ä¸€å€‹å€åŸŸè®Šæ•¸ `name`ã€‚
3. `makeFunc()` è£¡é¢å®šç¾©äº†ä¸€å€‹å‡½å¼ `displayName()`ã€‚**æ³¨æ„ï¼š`displayName()` èƒ½å¤ å­˜å–å¤–å±¤çš„ `name` è®Šæ•¸ã€‚**
4. **`makeFunc()`çš„å›å‚³å€¼æ˜¯`displayName`é€™å€‹å‡½å¼ã€‚**
5. æœ€å¾Œï¼Œæˆ‘å€‘å°‡ `makeFunc()` çš„å›å‚³å€¼å­˜åœ¨ `func1` è®Šæ•¸ä¸­ï¼Œä¸¦ä¸”å‘¼å« `func1`ã€‚

```Javascript
function makeFunc() { // 1
  let name = "John" // 2
  function displayName() { // 3
    console.log(name);
  }
  return displayName; // 4
}

let func1 = makeFunc(); // 5
func1();
```

ç•¶ `func1()` è¢«å‘¼å«çš„æ™‚å€™ï¼Œå¯¦éš›ä¸Šå°±æ˜¯å‘¼å« `makeFunc()` å›å‚³çš„ `displayName` å‡½æ•¸ã€‚

å•é¡Œä¾†äº†ï¼š

> ç•¶ `displayName()` è¢«å‘¼å«æ™‚ï¼ŒæœƒåŸ·è¡Œ `console.log(name)`ã€‚
> è®Šæ•¸ `name` æ˜¯å®šç¾©åœ¨ `makeFunc()` è£¡çš„ä¸€å€‹å€åŸŸè®Šæ•¸ï¼Œè€Œ `makeFunc()` å·²ç¶“çµæŸåŸ·è¡Œä¸¦å›å‚³äº†ã€‚
> è«‹å•å‘¼å« `func1()` çš„æ™‚å€™ï¼Œ`name` çš„å€¼æœƒæ˜¯ä»€éº¼ï¼Ÿ

ç­”æ¡ˆæ˜¯ `"John"`ã€‚

ç‚ºä»€éº¼å‘¢ï¼ŸğŸ¤”æ˜æ˜ `makeFunc()` å·²ç¶“çµæŸåŸ·è¡Œä¸¦å›å‚³äº†ï¼Œ`name`å»æ²’æœ‰è·Ÿè‘—æ¶ˆå¤±å‘¢ï¼Ÿ

åŸå› è·Ÿä»¥ä¸‹ã€Œé€™å€‹ã€ç‰¹æ€§æœ‰é—œã€‚

æˆ‘å€‘çŸ¥é“åœ¨æŸäº›ç¨‹å¼èªè¨€ä¸­ï¼Œå¦‚æœå‡½å¼å›å‚³äº†ï¼Œå®šç¾©åœ¨å…¶å…§éƒ¨çš„å€åŸŸè®Šæ•¸å°±æœƒæ¶ˆå¤±ã€‚

ä½†åœ¨JavaScriptä¸¦éå¦‚æ­¤ï¼

> **åœ¨JavaScriptä¸­ï¼Œå³ä½¿åœ¨å¤–å±¤å€å¡Šå·²ç¶“å›å‚³çš„ç‹€æ³ä¸‹ï¼Œåªè¦å…§å±¤å€å¡Šé‚„ä¿ç•™è‘—ä¸€ä»½åƒè€ƒï¼Œé‚£éº½å¤–å±¤å€å¡Šçš„ç’°å¢ƒä¸æœƒéš¨è‘—å›å‚³è€Œæ¶ˆå¤±ï¼Œæˆ‘å€‘ä¾ç„¶å¯ä»¥å­˜å–å¤–å±¤ç’°å¢ƒä¸­çš„è®Šæ•¸ã€‚**

ä»¥é€™å€‹ä¾‹å­ä¾†èªªï¼Œé›–ç„¶ `makeFunc()` å›å‚³äº†ï¼Œä½†æ˜¯å› ç‚ºæˆ‘å€‘é‚„ä¿ç•™è‘—ä¸€ä»½ `displayName` çš„åƒè€ƒï¼ˆå­˜åœ¨ `func1` è®Šæ•¸è£¡ï¼‰ï¼Œæ‰€ä»¥ JavaScript æœƒåœ¨è¨˜æ†¶é«”ä¸­ç‚ºæˆ‘å€‘ç¹¼çºŒä¿ç•™ `displayName` æ‰€åœ¨çš„ç’°å¢ƒï¼ŒåŒ…å« `name` è®Šæ•¸ç­‰ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥ç¹¼çºŒå­˜å– `name` è®Šæ•¸ã€‚

é€™å°±æ˜¯ closure çš„æ¦‚å¿µï¼šä¸€å€‹å‡½å¼å’Œå®ƒçš„æ‰€è™•ç’°å¢ƒæ˜¯å¯†ä¸å¯åˆ†çš„ï¼Œæ‰€ä»¥åªè¦æˆ‘å€‘é‚„éœ€è¦ç”¨åˆ°å‡½å¼çš„ä¸€å¤©ï¼Œå‡½å¼æ‰€åœ¨çš„ç’°å¢ƒä»¥åŠæ‰€åŒ…å«çš„è®Šæ•¸éƒ½æœƒç¹¼çºŒå­˜åœ¨ã€‚

çœ‹å®Œäº†é€™å€‹ä¾‹å­ï¼Œæ‡‰è©²å¯ä»¥äº†è§£ **é–‰åŒ… (closure) å¯ä»¥ã€Œä¿ç•™ã€ç’°å¢ƒ** æ˜¯ä»€éº¼æ„æ€ã€‚

é–‰åŒ…çš„ç‰¹æ€§é‚„ä¸åªå¦‚æ­¤å–”ã€‚

è®“æˆ‘å€‘ç¹¼çºŒçœ‹ä¸‹å»ï¼

### æ¯æ¬¡å‡½å¼è¢«å‘¼å«æ™‚ï¼Œéƒ½æœƒå‰µé€ ä¸€çµ„æ–°çš„èªå½™ç’°å¢ƒ (Lexical Environment)

è¦èªªæ˜é€™å€‹ç‰¹æ€§ï¼Œæˆ‘å€‘å¾ä¸€å€‹ä¾‹å­é–‹å§‹æ€è€ƒï¼š

é¦–å…ˆï¼Œå®šç¾©ä¸€å€‹ `makeAdder()` å‡½å¼ï¼Œæ¥å— `x` ä½œç‚ºåƒæ•¸ï¼Œå›å‚³ä¸€å€‹ä»¥ `y` ä½œç‚ºåƒæ•¸ï¼Œä¸¦å›å‚³ `x + y` çµæœçš„ `add()` å‡½å¼ã€‚

```Javascript
function makeAdder(x) {
  function add(y) {
    return x + y;
  }
  return add;
}

const add5 = makeAdder(5);
const add10 = makeAdder(10);

add5(2) // ?
add10(2) // ?
```

æˆ‘å€‘åˆ†åˆ¥å‘¼å«äº† `makeAdder(5)` å’Œ `makeAdder(10)`ï¼Œä¸¦åˆ†åˆ¥å°‡çµæœå­˜åœ¨ `add5` å’Œ `add10` ä¸­ã€‚

å› ç‚º closure çš„ç‰¹æ€§ï¼Œ`add5` å’Œ `add10` èƒ½å¤ è¨˜ä½å®£å‘Šç•¶ä¸‹çš„èªå½™ç’°å¢ƒ (Lexical Environment)ï¼ŒåŒ…æ‹¬è®Šæ•¸ `x`ã€‚

å•é¡Œä¾†äº†ï¼š

> 1. `add5(2)` = ?
> 2. `add10(2)` = ?

ç­”æ¡ˆåˆ†åˆ¥æ˜¯ 7 å’Œ 12ã€‚ç‚ºä»€éº¼å‘¢ï¼ŸğŸ¤”

å•é¡Œçš„é—œéµåœ¨æ–¼ï¼Œå°æ–¼ `add5` å’Œ `add10` é€™å…©å€‹å‡½æ•¸è€Œè¨€ï¼Œ`x` çš„å€¼æ˜¯ä»€éº¼ï¼Ÿä»–å€‘çœ‹åˆ°çš„æ˜¯ç›¸åŒçš„ `x`ï¼Ÿé‚„æ˜¯ä¸åŒçš„ `x`ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼šå° `add5` è€Œè¨€ï¼Œ`x` ç­‰æ–¼ 5ï¼›å° `add10` è€Œè¨€ï¼Œ`x` ç­‰æ–¼ 10ã€‚

ç†ç”±æ˜¯å› ç‚ºé€™å€‹ç‰¹æ€§ï¼š

> **æ¯ç•¶å‡½å¼è¢«å‘¼å«æ™‚ï¼Œéƒ½æœƒç”¢ç”Ÿä¸€çµ„æ–°çš„èªå½™ç’°å¢ƒ (Lexical Environment)ã€‚**

ä»¥ä¸Šé¢çš„ä¾‹å­è€Œè¨€ï¼Œå‘¼å«äº†å…©æ¬¡çš„ `makeAdder()`ï¼Œä¸€å…±ç”¢ç”Ÿäº†å…©çµ„ç’°å¢ƒã€‚

å‘¼å« `makeAdder(5)` çš„æ™‚å€™ï¼Œå‰µé€ äº†ä¸€çµ„ `x` ç­‰æ–¼ 5 çš„ç’°å¢ƒï¼Œä¸¦ä¸”å°‡å›å‚³çµæœæŒ‡å®šçµ¦ `add5`ã€‚

å› ç‚º closure çš„ç‰¹æ€§ï¼Œå‡½å¼ `add5` èƒ½å¤ å­˜å–é€™çµ„ `x` ç­‰æ–¼ 5 çš„ç’°å¢ƒï¼Œå› æ­¤çœ‹åˆ°çš„ `x` ç­‰æ–¼ 5ã€‚

å‘¼å« `makeAdder(10)` çš„æ™‚å€™ï¼Œå‰µé€ äº†å¦ä¸€çµ„ `x` ç­‰æ–¼ 10 çš„ç’°å¢ƒï¼Œä¸¦ä¸”å°‡å›å‚³çµæœæŒ‡å®šçµ¦ `add10`ã€‚

åŒç†ï¼Œå‡½å¼ `add10` çœ‹åˆ°çš„ `x` ç­‰æ–¼ 10ã€‚

ç¸½è€Œè¨€ä¹‹ï¼Œ`add5` å’Œ `add10` çœ‹åˆ°çš„ `x` è®Šæ•¸åœ¨è¨˜æ†¶é«”ä¸­æ˜¯ä¸ä¸€æ¨£çš„å…©å€‹è®Šæ•¸ã€‚

### å°çµ

è¾›è‹¦äº†ï¼ğŸ™‡

çœ‹åˆ°é€™è£¡ï¼Œä½ æ‡‰è©²å¤§è‡´äº†è§£ closure çš„ç‰¹æ€§äº†å§ï¼

åœ¨ JavaScript ä¸­ï¼Œclosure å…¶å¯¦æ‰®æ¼”å¾ˆé‡è¦çš„è§’è‰²å–”ï¼

ä¸‹é¢æˆ‘å€‘å°±ä¾†çœ‹çœ‹ä¸€äº› closure çš„å¯¦éš›æ‡‰ç”¨å§ï¼

## é–‰åŒ… (Closure) çš„æ‡‰ç”¨

é–‰åŒ… (closure) åœ¨æ¯”è¼ƒé«˜å±¤æ¬¡çš„æ¦‚å¿µä¸Šï¼Œå¯ä»¥æƒ³æˆæŠŠå‡½å¼å’Œä¸€çµ„è³‡æ–™é—œè¯èµ·ä¾†ã€‚

é€™å°æ‡‰åˆ°ç‰©ä»¶å°å‘ç¨‹å¼è¨­è¨ˆ (Object-Oriented Programming) ä¸­ï¼Œç‰©ä»¶æ–¹æ³•å¯ä»¥å­˜å–ç‰©ä»¶å±¬æ€§ (property) çš„ç‰¹æ€§ã€‚

ä¸‹é¢æˆ‘å€‘å°±ä¾†çœ‹å¹¾å€‹ç°¡å–®çš„æ‡‰ç”¨ï¼š

### ç”¨é–‰åŒ… (Closure) æ¨¡æ“¬ç‰©ä»¶å°å‘ä¸­çš„ç§æœ‰æˆå“¡ (Private Member)

æˆ‘å€‘å¯ä»¥ç”¨Closureçš„ç‰¹æ€§æ¨¡æ“¬ç‰©ä»¶å°å‘ä¸­çš„ç§æœ‰æˆå“¡(private member)ã€‚

(é€™å€‹æ–¹æ³•æœ‰æ™‚åˆè¢«ç¨±ä½œ Module Patternã€‚)

ä¸‹é¢é€™å€‹ä¾‹å­ï¼Œæˆ‘å€‘å‰µé€ ä¸€å€‹`counter`ç‰©ä»¶ï¼Œä¸¦æä¾›ä¸‰å€‹æ–¹æ³•å­˜å–ç‰©ä»¶å…§éƒ¨çš„`count`è®Šæ•¸ã€‚

```Javascript
const counter = (function() {
  let count = 0
  function changeBy(val) {
    count += val
  }

  return {
    increment: function() {
      changeBy(1)
    },
    decrement: function() {
      changeBy(-1)
    },
    value: function() {
      return count
    }
  }
})();

counter.value() // 0
counter.increment()
counter.increment()
counter.value() // 2
counter.decrement()
counter.value() // 1
```

ç‰©ä»¶çš„ä¸‰å€‹æ–¹æ³• (`increment`, `decrement`, `value`) å…±åŒèƒ½å¤ å­˜å–åŒä¸€çµ„ç’°å¢ƒ(Lexical Environment)ï¼Œå› æ­¤ä»–å€‘éƒ½èƒ½å¤ å­˜å–åŒä¸€çµ„`count`åŠ`changeBy`ã€‚

é™¤äº†é€é`counter`ç‰©ä»¶ä¸Šçš„æ–¹æ³•ä»¥å¤–ï¼Œæˆ‘å€‘æ²’è¾¦æ³•ç›´æ¥å­˜å–å…¶å…§éƒ¨çš„`count`è®Šæ•¸ã€‚

â˜ï¸`count`å°±ç›¸ç•¶æ–¼ç‰©ä»¶å°å‘ä¸­çš„ç§æœ‰æˆå“¡è®Šæ•¸private memberã€‚

### ç”¨é–‰åŒ… (Closure) é”åˆ°è³‡æ–™éš”é›¢çš„æ•ˆæœ

æˆ‘å€‘å¯ä»¥æŠŠä¸Šé¢çš„ä¾‹å­æ”¹å¯«æˆå·¥å» å‡½å¼ `makeCounter`ï¼Œç”¨ä¾†ç”¢ç”Ÿæ›´å¤šçš„ counter ç‰©ä»¶ã€‚

é€™è£¡ç”¢ç”Ÿäº†å…©å€‹ç‰©ä»¶`counter1`å’Œ`counter2`ã€‚

â˜ï¸`counter1`å’Œ`counter2`æ“æœ‰å„è‡ªçš„`count`è®Šæ•¸ï¼Œä¸æœƒäº’ç›¸å¹²æ“¾ï¼Œé”åˆ°è³‡æ–™äº’ç›¸éš”é›¢çš„æ•ˆæœã€‚

```Javascript
const makeCounter = function() {
  let count = 0
  function changeBy(val) {
    count += val
  }

  return {
    increment: function() {
      changeBy(1)
    },
    decrement: function() {
      changeBy(-1)
    },
    value: function() {
      return count
    }
  }
}

let counter1 = makeCount()
let counter2 = makeCount()

counter1.increment()
counter1.increment()

counter2.decrement()

counter1.value() // 2
counter2.value() // -1
```

### é¿å… for loop ä¸­ä½¿ç”¨ callback function çš„éŒ¯èª¤å¯«æ³•

åœ¨ä»¥å‰åªæœ‰`var`çš„æ™‚ä»£ï¼Œåœ¨for loopè£¡ä½¿ç”¨callbackå‡½å¼å¾ˆå®¹æ˜“ä¸å°å¿ƒå¯«éŒ¯ã€‚

èˆ‰å€‹ä¾‹å­ï¼Œå‡è¨­ç¾åœ¨è¦å¯«ä¸€æ®µcodeèƒ½å¤ æ¯éš”ä¸€ç§’åˆ†åˆ¥å°å‡º0 1 2 3 4ã€‚

ä½ å¯èƒ½æœƒå¯«æˆé€™æ¨£ï¼Œç”¨`setTimeout`æ­é…ä¸€å€‹for loopå»å¯«ï¼š

```Javascript
for (var i = 0; i < 5; ++i) {
  setTimeout(function() {
    console.log(i)
  }, 1000 * i)
}
```

ä½†é€™æ¨£å¯«æ˜¯éŒ¯çš„âŒã€‚

é€™æ®µcodeå¯¦éš›ä¸Šæœƒå°å‡º `5 5 5 5 5` ã€‚

ç‚ºä»€éº¼å‘¢ï¼ŸğŸ¤”

å› ç‚º`var`å®£å‘Šçš„è®Šæ•¸æ˜¯ä»¥å‡½å¼ä½œç‚ºscopeï¼Œæ‰€ä»¥ä¸Šé¢é‚£ç¨®å¯«æ³•çš„`i`å¯ä»¥çœ‹æˆæ˜¯å…¨åŸŸè®Šæ•¸ï¼š

```Javascript
var i; // A global variable!
for (i = 0; i < 5; ++i) {
  setTimeout(function() {
    console.log(i)
  }, 1000 * i)
}
// After the execution of the for loop, i = 5
```

å› æ­¤æœƒç”¢ç”Ÿäº”å€‹callback functionï¼Œä»–å€‘çœ‹åˆ°çš„è®Šæ•¸`i`éƒ½æ˜¯åŒä¸€å€‹ã€‚

è€Œè·‘å®Œfor loopå¾Œï¼Œ`i` = 5ã€‚ç•¶callback functionå¯¦éš›è¢«å‘¼å«åˆ°æ™‚ï¼Œæ‰æœƒå»çœ‹`i`å¯¦éš›çš„å€¼ï¼Œä¹Ÿå°±æ˜¯5ï¼Œæ‰€ä»¥æ‰æœƒå°å‡º5 5 5 5 5ã€‚

é‚£æˆ‘å€‘åˆ°åº•è©²æ€éº¼åšæ‰å°å‘¢ï¼ŸğŸ¤”

é—œéµæ˜¯ï¼šæˆ‘å€‘éœ€è¦è®“æ¯å€‹callback functionéƒ½å¯ä»¥è¨˜ä½å„è‡ªçš„`i`ã€‚

â˜ï¸æ‰€ä»¥æˆ‘å€‘å¿…é ˆè¦é‹ç”¨closureçš„ç‰¹æ€§ï¼Œè®“æ¯å€‹callback functionéƒ½æœ‰å„è‡ªçš„ç’°å¢ƒã€‚

å¯¦éš›ä¸Šçš„åšæ³•å°±æ˜¯ç”¨ä¸€å€‹functionåŒ…èµ·ä¾†ã€‚

ğŸ‘‡ä¸‹é¢åˆ—èˆ‰äº†å¹¾ç¨®å¯èƒ½çš„è§£æ³•ï¼š

#### ç”¨ IIFE åŒ…èµ·ä¾†åŸ·è¡Œ

ç¬¬ä¸€ç¨®æ–¹æ³•æ˜¯ï¼šæŠŠæ•´æ®µcodeåŒ…åœ¨ä¸€å€‹IIFEä¸­å»åŸ·è¡Œã€‚

for loopçš„æ¯å€‹iterationå‘¼å«IIFEæ™‚ï¼Œéƒ½æœƒç”¢ç”Ÿä¸€çµ„æ–°çš„ç’°å¢ƒï¼Œä¸¦ä¸”`i`çš„å€¼æœƒcopyçµ¦`j`ï¼Œé€™æ¨£æ¯å€‹callbackéƒ½æœƒæœ‰å„è‡ªçš„`j`äº†ã€‚

```Javascript
for (var i = 0; i < 5; ++i) {
  (function(j) {
    setTimeout(function() {
      console.log(j)
    }, 1000 * j)
  })(i);
}
```

#### ç”¨ IIFE ç”¢ç”Ÿ callback function

ç¬¬äºŒç¨®æ–¹æ³•æ˜¯ï¼šç”¨IIFEç›´æ¥å›å‚³ä¸€å€‹callback functionã€‚

for loopçš„æ¯å€‹iterationå‘¼å«IIFEæ™‚ï¼ŒåŒæ¨£æœƒç”¢ç”Ÿä¸€çµ„æ–°çš„ç’°å¢ƒï¼Œä¹ŸæœƒæŠŠ`i`çš„å€¼æœƒcopyçµ¦`j`ã€‚

èˆ‡å‰ä¸€ç¨®åšæ³•çš„å·®åˆ¥æ˜¯ï¼ŒIIFEæœ€å¾Œè¦å›å‚³`setTimeout`éœ€è¦çš„callback functionã€‚

```Javascript
for (var i = 0; i < 5; ++i) {
  setTimeout((function(j) {
    return function() {
      console.log(j)
    }
  })(i), 1000 * i)
}
```

#### ç”¨ let

å¦‚æœæ²’æœ‰ç¡¬è¦ç”¨closureè§£æ±ºé€™å€‹å•é¡Œçš„è©±ï¼Œå…¶å¯¦ç”¨`let`è§£æ±ºæ˜¯æœ€å¿«çš„ï¼š

```Javascript
for (let i = 0; i < 5; ++i) {
  setTimeout(function() {
    console.log(i)
  }, 1000 * i)
}
```

## è£œå……èªªæ˜ï¼šLexical Environment (èªå½™ç’°å¢ƒ)

ä¸Šé¢ä¸€ç›´æåˆ°èªå½™ç’°å¢ƒ (Lexical Environment) é€™å€‹è©å½™ï¼Œé€™é‚Šç¨åŠ è£œå……èªªæ˜ã€‚

JavaScript ä¸­ï¼Œä¸€æ®µ code èƒ½å¤ å­˜å–å“ªäº›è®Šæ•¸ï¼Œæ˜¯ç”± code æ‰€åœ¨çš„ lexical environment æ±ºå®šçš„ã€‚

æ‰€è¬‚ lexical enviroment åŒ…å«äº†ï¼š

1. å€åŸŸè®Šæ•¸
2. å¤–å±¤çš„ Lexical Environment çš„åƒè€ƒï¼ˆå¯ä»¥ç°¡å–®æƒ³åƒæˆå¤§æ‹¬è™Ÿå¤–çš„å€åŸŸï¼‰

ä¸€æ®µ code è¦å­˜å–ä¸€å€‹è®Šæ•¸çš„æ™‚å€™ï¼Œæœƒå…ˆåœ¨ç•¶ä¸‹çš„ Lexical Environment æ‰¾ï¼Œæ‰¾ä¸åˆ°æœƒå†å¾€å¤–å±¤æ‰¾ï¼Œç›´åˆ° global scope ç‚ºæ­¢ã€‚

é€™å°±æ˜¯å…§å±¤çš„ function å­˜å–å¤–å±¤å®£å‘Šçš„è®Šæ•¸çš„åŸç†ã€‚

<!-- TODO: æˆ–è¨±å¯åŠ ä¸€æ®µç¨‹å¼ç¢¼èªªæ˜ -->

## çµèª

çœ‹åˆ°é€™è£¡ï¼Œå¸Œæœ›ä½ å·²ç¶“å°JavaScript Closure(é–‰åŒ…)çš„æ¦‚å¿µä»¥åŠå¯¦éš›æ‡‰ç”¨æœ‰äº†æ·±å…¥äº†è§£ï¼é€™ç¯‡æ–‡ç« çš„ä¾‹å­å’Œèªªæ˜å¤§éƒ¨åˆ†éƒ½æ˜¯åƒè€ƒè‡ª[MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures)èˆ‡[JavaScript.info](http://javascript.info/closure)ï¼Œæœ‰èˆˆè¶£æ›´æ·±å…¥äº†è§£Closureçš„æœ‹å‹å¯ä»¥å†å»çœ‹çœ‹å–”ï¼

æœ‰ä»»ä½•å•é¡Œï¼Œæˆ–æ˜¯è¦ºå¾—å¯«å¾—ä¸æ¸…æ¥šçš„åœ°æ–¹ï¼Œæ­¡è¿åœ¨ä¸‹é¢ğŸ‘‡ğŸ‘‡ğŸ‘‡ç•™è¨€è®“æˆ‘çŸ¥é“å–”ã€‚

## Reference

[Closures - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures)

[Closure - javascript.info](http://javascript.info/closure)

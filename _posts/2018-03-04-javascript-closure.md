---
title: "[æ•™å­¸] JavaScript Closure (é–‰åŒ…)ã€å‡½å¼èˆ‡èªå½™ç’°å¢ƒ"
tags: ["javascript"]
redirect_from: /2018/03/04/javascript-closure-in-depth
last_modified_at: 2020/07/20
---

JavaScript ä¸­çš„é–‰åŒ… (Closure) æ˜¯å‡½å¼ä»¥åŠå…¶èªå½™ç’°å¢ƒ (Lexical Environment) çš„çµ„åˆï¼Œæ‰€æœ‰çš„å‡½å¼éƒ½èƒ½å¤ è¨˜ä½è¢«å‰µé€ çš„ç•¶ä¸‹çš„ç’°å¢ƒä»¥åŠè®Šæ•¸ã€‚é€™ç¯‡æ•™å­¸å°‡æœƒå¾ JavaScript å‡½å¼çš„ç‰¹æ€§é–‹å§‹è¬›è§£ï¼ŒåŒ…å«è®Šæ•¸çš„å­˜å–è¦å‰‡ã€ä»¥åŠå‡½å¼å¯ä»¥ä½œç‚ºå¦ä¸€å€‹å‡½å¼çš„å›å‚³å€¼ï¼Œæœ€å¾Œå¸¶åˆ° closure çš„ç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯å‡½å¼èƒ½å¤ ä¿ç•™å…¶ç’°å¢ƒã€‚æœ¬ç¯‡é‚„æœƒè¬›è§£ closure çš„å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹ï¼ŒåŒ…æ‹¬ IIFE (Immediately Invoked Function Expression)ã€ä»¥åŠç”¨ closure çš„ç‰¹æ€§æ¨¡æ“¬ç‰©ä»¶å°å‘ä¸­çš„ private member ä»¥é”åˆ°å°è£çš„ç‰¹æ€§ (åˆç¨±ç‚º module pattern)ã€‚

![Sea Turtle](/images/sea-turtle.jpg)

## é–‰åŒ… (Closure) æ˜¯ä»€éº¼ï¼Ÿ

ç°¡å–®ç”¨ä¸€å¥è©±è§£é‡‹ closure å°±æ˜¯ï¼š**é–‰åŒ… (Closure) æ˜¯ä¸€ç¨®å‡½å¼ï¼Œå®ƒèƒ½å¤ å­˜å–è¢«å®£å‘Šç•¶ä¸‹çš„ç’°å¢ƒä¸­çš„è®Šæ•¸ã€‚**

[MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures)ä¸Šå° closure æ¯”è¼ƒæ­£å¼çš„å®šç¾©æ˜¯ï¼š

> A closure is the combination of a function and the Lexical Environment within which that function was declared.

ç¿»è­¯æˆä¸­æ–‡å°±æ˜¯ï¼šclosure æ˜¯ä¸€å€‹å‡½æ•¸å’Œæ­¤å‡½æ•¸è¢«å®£å‘Šæ™‚æ‰€åœ¨çš„èªå½™ç’°å¢ƒã€‚

è®“æˆ‘ä¾†ç‚ºå¤§å®¶ç¿»è­¯ä¸€ä¸‹ï¼Œé€™å¥è©±çš„æ„æ€æ˜¯ï¼šClosure æ˜¯ç”±å…©å€‹ä¸»é«”æ§‹æˆçš„ä¸€å€‹çµ„åˆï¼Œåˆ†åˆ¥æ˜¯ï¼š

1. å‡½å¼ (function)
2. å‡½å¼è¢«å®£å‘Šæ™‚æ‰€åœ¨çš„èªå½™ç’°å¢ƒ (Lexical Environment)ã€‚

å‡½å¼å¤§å®¶æ‡‰è©²éƒ½å¾ˆç†Ÿæ‚‰ï¼Œä½†æ‰€è¬‚çš„ã€Œèªå½™ç’°å¢ƒã€åˆæ˜¯ä»€éº¼å‘¢ï¼Ÿ

èªå½™ç’°å¢ƒç°¡å–®åœ°èªªï¼Œå°±æ˜¯å‡½å¼è¢«å®£å‘Šæ™‚æ‰€åœ¨çš„ scopeï¼Œé€™å€‹ scope è£¡é¢åŒ…å«äº†èƒ½å¤ è¢«é€™å€‹å‡½å¼å­˜å–åˆ°çš„è®Šæ•¸ã€‚ç‚ºäº†æ–¹ä¾¿ç†è§£ï¼Œä½ å¯ä»¥æŠŠèªå½™ç’°å¢ƒæƒ³æˆæ˜¯**å‡½å¼èƒ½å¤ å­˜å–åˆ°çš„æ‰€æœ‰è®Šæ•¸ã€‚**

å› æ­¤ closure å°±æ˜¯**ä¸€å€‹å‡½å¼èƒ½å¤ å­˜å–è‡ªå·±è¢«å®£å‘Šæ™‚çš„ç’°å¢ƒä¸­çš„è®Šæ•¸ã€‚**

å‰é¢è¬›çš„æ±è¥¿ï¼Œæ²’æœ‰æ­é…å¯¦éš›çš„ç¨‹å¼ç¢¼æˆ–è¨±æœƒæœ‰é»é›£ç†è§£ï¼Œä½†æ˜¯åˆ¥æ“”å¿ƒï¼ä¸‹é¢æˆ‘æœƒç”¨ä¸€äº›å¾ˆç°¡å–®çš„ç¨‹å¼ç¢¼ç¯„ä¾‹èªªæ˜ closureï¼Œä¹‹å¾Œå†å›é ­çœ‹é€™æ®µçš„è©±ï¼Œæ‡‰è©²æœƒæ¯”è¼ƒæœ‰æ„Ÿè¦ºï¼

è®“æˆ‘å€‘ç¹¼çºŒçœ‹ä¸‹å»ï¼

### JavaScript çš„è®Šæ•¸å­˜å–è¦å‰‡

è¦ç†è§£ closureï¼Œé¦–å…ˆæˆ‘å€‘è¦è«‡è«‡ JavaScript ä¸­ï¼Œé—œæ–¼**è®Šæ•¸å­˜å–çš„è¦å‰‡**ã€‚

ä¸‹é¢ç›´æ¥èˆ‰ä¸€æ®µç¨‹å¼ç¢¼ç•¶ä½œä¾‹å­ï¼š

```Javascript
function sayHi() {
  let name = "John"; // (1)
  function displayName() { // (2)
    console.log(name);
  }
  displayName();
}

sayHi();
```

é¦–å…ˆï¼Œæˆ‘å€‘å®£å‘Šä¸€å€‹å‡½å¼ `sayHi()`ï¼Œåœ¨è£¡é ­å®£å‘Šäº†ä¸€å€‹è®Šæ•¸ `name` (1) å’Œä¸€å€‹å‡½å¼ `displayName()` (2)ï¼Œ`displayName()` å…§éƒ¨æœƒç”¨åˆ° `name` é€™å€‹è®Šæ•¸ã€‚æœ€å¾Œæˆ‘å€‘å‘¼å« `sayHi()`ã€‚

å•é¡Œä¾†å›‰ï¼š

> è®Šæ•¸ `name` ä¸¦ä¸æ˜¯å®£å‘Šåœ¨ `displayName()` å…§ï¼Œè€Œæ˜¯å®£å‘Šåœ¨ä»–çš„å¤–éƒ¨ç’°å¢ƒ `init()`ã€‚
> è«‹å•é€™ç¨®æƒ…æ³ä¸‹ `console.log(name)` æœƒå°å‡ºä»€éº¼å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ `"John"`ã€‚ç‚ºä»€éº¼å‘¢ï¼Ÿ

å› ç‚º JavaScript çš„è®Šæ•¸å°‹æ‰¾è¦å‰‡æ˜¯ï¼š

> **å…§å±¤å€å¡Šå¯ä»¥å­˜å–å®šç¾©åœ¨å¤–å±¤å€å¡Šçš„è®Šæ•¸ã€‚åéä¾†èªªï¼Œå¤–å±¤å€å¡Šæ²’è¾¦æ³•å­˜å–å…§å±¤å€å¡Šçš„è®Šæ•¸ã€‚**

æ‰€ä»¥å…§å±¤å€å¡Š `displayName()` å¯ä»¥å­˜å–å®šç¾©åœ¨å¤–å±¤å€å¡Š `init()` çš„è®Šæ•¸ `name`ã€‚

> é€™æ¨£çš„è®Šæ•¸æŸ¥æ‰¾è¦å‰‡ï¼Œæœ‰å€‹å°ˆæœ‰åè©å«åš *Lexical Scoping*ã€‚å¤§éƒ¨åˆ†çš„ç¨‹å¼èªè¨€éƒ½æ¡ç”¨é¡ä¼¼çš„è®Šæ•¸æŸ¥æ‰¾è¦å‰‡ï¼Œå¦å¤–æœ‰ä¸€ç¨® *Dynamic Scoping* çš„è¦å‰‡ï¼Œä½†æˆ‘å°±æ²’è©³ç´°ç ”ç©¶å›‰ï¼Œå¤§å®¶æœ‰èˆˆè¶£å¯ä»¥çœ‹çœ‹é€™ç¯‡é—œæ–¼[Lexical Scopingçš„ä»‹ç´¹](https://stackoverflow.com/questions/1047454/what-is-lexical-scope)ã€‚

æˆ–è¨±ä½ æœƒè¦ºå¾—ï¼Œé€™ä»¶äº‹ä¸æ˜¯ç†æ‰€ç•¶ç„¶çš„å—ï¼Ÿ

å…ˆåˆ¥æ€¥ï¼Œè®“æˆ‘å€‘è€å¿ƒçœ‹ä¸‹å»ï¼ğŸ‘‡

### å‡½å¼å¯ä»¥ç•¶ä½œå¦ä¸€å€‹å‡½å¼çš„å›å‚³å€¼

JavaScript çš„å¦ä¸€å€‹ç‰¹è‰²æ˜¯ï¼šå‡½å¼åœ¨ JavaScript ä¸­æ˜¯[ä¸€ç­‰å…¬æ°‘ (first-class)](https://developer.mozilla.org/en-US/docs/Glossary/First-class_Function)ã€‚

é€™æ˜¯ä»€éº¼æ„æ€å‘¢ï¼Ÿç™½è©±æ–‡çš„è§£é‡‹å°±æ˜¯åœ¨ JavaScript ä¸­ï¼Œå‡½å¼æ˜¯ä¸€ç¨®ç‰©ä»¶ã€‚

**å› ç‚ºå‡½å¼æ˜¯ç‰©ä»¶ï¼Œæ‰€ä»¥å‡½å¼ä¸åƒ…å¯ä»¥ä½œç‚ºå‡½å¼çš„åƒæ•¸ï¼Œä¹Ÿå¯ä»¥ç•¶ä½œå‡½å¼çš„å›å‚³å€¼ã€‚**

ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘å€‘æŠŠ `sayHi` ç•¶æˆæ˜¯å‡½æ•¸çš„å›å‚³å€¼ (1)ï¼š

```JavaScript
function makeSayHi() {
  function sayHi() {
    console.log("John");
  }
  return sayHi; // (1)
}

const sayHi = makeSayHi(); // (2)
sayHi(); // John
```

ç•¶æˆ‘å€‘å‘¼å« `makeSayHi()`ï¼Œå°±æœƒå›å‚³ä¸€å€‹å¯ä»¥è¢«å‘¼å«çš„å‡½å¼ (2)ã€‚

ä½ å¯èƒ½æœƒå•ï¼Œå‡½å¼å¯ä»¥ç•¶ä½œå›å‚³å€¼ï¼Œé‚£åˆæ€æ¨£ï¼Ÿå…¶å¯¦é€™å€‹ç‰¹æ€§æœƒè·Ÿä¸‹ä¸€å€‹è¦æåˆ°çš„ç‰¹æ€§æœ‰é—œã€‚

è®“æˆ‘å€‘å¾€ä¸‹çœ‹ï¼

### Closure å¯ä»¥ã€Œä¿ç•™ã€ç’°å¢ƒ

ç¬¬ä¸‰å€‹ç‰¹æ€§æ˜¯ï¼šé–‰åŒ… (closure) å¯ä»¥ã€Œä¿ç•™ã€ç’°å¢ƒã€‚é€™å€‹ç‰¹æ€§æœƒç”¨åˆ°å‰é¢æéçš„å…©å€‹ç‰¹æ€§ï¼šå‡½å¼å¯ä»¥å­˜å–å¤–å±¤è®Šæ•¸ï¼Œä»¥åŠå‡½å¼å¯ä»¥ä½œç‚ºå›å‚³å€¼ã€‚

æˆ‘ç”¨ä¸‹é¢é€™å€‹ä¾‹å­ä¾†èªªæ˜ï¼š

1. é¦–å…ˆå®šç¾©ä¸€å€‹å‡½å¼ `makeFunc()`ã€‚
2. `makeFunc()` è£¡é¢å®šç¾©äº†ä¸€å€‹å€åŸŸè®Šæ•¸ `name`ã€‚
3. `makeFunc()` è£¡é¢å®šç¾©äº†ä¸€å€‹å‡½å¼ `displayName()`ã€‚**æ³¨æ„ï¼š`displayName()` èƒ½å¤ å­˜å–å¤–å±¤çš„ `name` è®Šæ•¸ã€‚**
4. **`makeFunc()`çš„å›å‚³å€¼æ˜¯`displayName`é€™å€‹å‡½å¼ã€‚**
5. æœ€å¾Œï¼Œæˆ‘å€‘å°‡ `makeFunc()` çš„å›å‚³å€¼å­˜åœ¨ `func1` è®Šæ•¸ä¸­ï¼Œä¸¦ä¸”å‘¼å« `func1`ã€‚

```Javascript
function makeFunc() { // 1
  let name = "John" // 2
  function displayName() { // 3
    console.log(name);
  }
  return displayName; // 4
}

let func1 = makeFunc(); // 5
func1();
```

ç•¶ `func1()` è¢«å‘¼å«çš„æ™‚å€™ï¼Œå¯¦éš›ä¸Šå°±æ˜¯å‘¼å« `makeFunc()` å›å‚³çš„ `displayName` å‡½æ•¸ã€‚

å•é¡Œä¾†äº†ï¼š

> ç•¶ `displayName()` è¢«å‘¼å«æ™‚ï¼ŒæœƒåŸ·è¡Œ `console.log(name)`ã€‚
> è®Šæ•¸ `name` æ˜¯å®šç¾©åœ¨ `makeFunc()` è£¡çš„ä¸€å€‹å€åŸŸè®Šæ•¸ï¼Œè€Œ `makeFunc()` å·²ç¶“çµæŸåŸ·è¡Œä¸¦å›å‚³äº†ã€‚
> è«‹å•å‘¼å« `func1()` çš„æ™‚å€™ï¼Œ`name` çš„å€¼æœƒæ˜¯ä»€éº¼ï¼Ÿ

ç­”æ¡ˆæ˜¯ `"John"`ã€‚

ç‚ºä»€éº¼å‘¢ï¼ŸğŸ¤”æ˜æ˜ `makeFunc()` å·²ç¶“çµæŸåŸ·è¡Œä¸¦å›å‚³äº†ï¼Œ`name`å»æ²’æœ‰è·Ÿè‘—æ¶ˆå¤±å‘¢ï¼Ÿ

åŸå› è·Ÿä»¥ä¸‹ã€Œé€™å€‹ã€ç‰¹æ€§æœ‰é—œã€‚

æˆ‘å€‘çŸ¥é“åœ¨æŸäº›ç¨‹å¼èªè¨€ä¸­ï¼Œå¦‚æœå‡½å¼å›å‚³äº†ï¼Œå®šç¾©åœ¨å…¶å…§éƒ¨çš„å€åŸŸè®Šæ•¸å°±æœƒæ¶ˆå¤±ã€‚

ä½†åœ¨JavaScriptä¸¦éå¦‚æ­¤ï¼

> **åœ¨JavaScriptä¸­ï¼Œå³ä½¿åœ¨å¤–å±¤å€å¡Šå·²ç¶“å›å‚³çš„ç‹€æ³ä¸‹ï¼Œåªè¦å…§å±¤å€å¡Šé‚„ä¿ç•™è‘—ä¸€ä»½åƒè€ƒï¼Œé‚£éº½å¤–å±¤å€å¡Šçš„ç’°å¢ƒä¸æœƒéš¨è‘—å›å‚³è€Œæ¶ˆå¤±ï¼Œæˆ‘å€‘ä¾ç„¶å¯ä»¥å­˜å–å¤–å±¤ç’°å¢ƒä¸­çš„è®Šæ•¸ã€‚**

ä»¥é€™å€‹ä¾‹å­ä¾†èªªï¼Œé›–ç„¶ `makeFunc()` å›å‚³äº†ï¼Œä½†æ˜¯å› ç‚ºæˆ‘å€‘é‚„ä¿ç•™è‘—ä¸€ä»½ `displayName` çš„åƒè€ƒï¼ˆå­˜åœ¨ `func1` è®Šæ•¸è£¡ï¼‰ï¼Œæ‰€ä»¥ JavaScript æœƒåœ¨è¨˜æ†¶é«”ä¸­ç‚ºæˆ‘å€‘ç¹¼çºŒä¿ç•™ `displayName` æ‰€åœ¨çš„ç’°å¢ƒï¼ŒåŒ…å« `name` è®Šæ•¸ç­‰ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥ç¹¼çºŒå­˜å– `name` è®Šæ•¸ã€‚

é€™å°±æ˜¯ closure çš„æ¦‚å¿µï¼šä¸€å€‹å‡½å¼å’Œå®ƒçš„æ‰€è™•ç’°å¢ƒæ˜¯å¯†ä¸å¯åˆ†çš„ï¼Œæ‰€ä»¥åªè¦æˆ‘å€‘é‚„éœ€è¦ç”¨åˆ°å‡½å¼çš„ä¸€å¤©ï¼Œå‡½å¼æ‰€åœ¨çš„ç’°å¢ƒä»¥åŠæ‰€åŒ…å«çš„è®Šæ•¸éƒ½æœƒç¹¼çºŒå­˜åœ¨ã€‚

çœ‹å®Œäº†é€™å€‹ä¾‹å­ï¼Œæ‡‰è©²å¯ä»¥äº†è§£ **é–‰åŒ… (closure) å¯ä»¥ã€Œä¿ç•™ã€ç’°å¢ƒ** æ˜¯ä»€éº¼æ„æ€ã€‚

é–‰åŒ…çš„ç‰¹æ€§é‚„ä¸åªå¦‚æ­¤å–”ã€‚

è®“æˆ‘å€‘ç¹¼çºŒçœ‹ä¸‹å»ï¼

### æ¯æ¬¡å‡½å¼è¢«å‘¼å«æ™‚ï¼Œéƒ½æœƒå‰µé€ ä¸€çµ„æ–°çš„èªå½™ç’°å¢ƒ (Lexical Environment)

è¦èªªæ˜é€™å€‹ç‰¹æ€§ï¼Œæˆ‘å€‘å¾ä¸€å€‹ä¾‹å­é–‹å§‹æ€è€ƒï¼š

é¦–å…ˆï¼Œå®šç¾©ä¸€å€‹ `makeAdder()` å‡½å¼ï¼Œæ¥å— `x` ä½œç‚ºåƒæ•¸ï¼Œå›å‚³ä¸€å€‹ä»¥ `y` ä½œç‚ºåƒæ•¸ï¼Œä¸¦å›å‚³ `x + y` çµæœçš„ `add()` å‡½å¼ã€‚

```Javascript
function makeAdder(x) {
  function add(y) {
    return x + y;
  }
  return add;
}

const add5 = makeAdder(5);
const add10 = makeAdder(10);

add5(2) // ?
add10(2) // ?
```

æˆ‘å€‘åˆ†åˆ¥å‘¼å«äº† `makeAdder(5)` å’Œ `makeAdder(10)`ï¼Œä¸¦åˆ†åˆ¥å°‡çµæœå­˜åœ¨ `add5` å’Œ `add10` ä¸­ã€‚

å› ç‚º closure çš„ç‰¹æ€§ï¼Œ`add5` å’Œ `add10` èƒ½å¤ è¨˜ä½å®£å‘Šç•¶ä¸‹çš„èªå½™ç’°å¢ƒ (Lexical Environment)ï¼ŒåŒ…æ‹¬è®Šæ•¸ `x`ã€‚

å•é¡Œä¾†äº†ï¼š

> 1. `add5(2)` = ?
> 2. `add10(2)` = ?

ç­”æ¡ˆåˆ†åˆ¥æ˜¯ 7 å’Œ 12ã€‚ç‚ºä»€éº¼å‘¢ï¼ŸğŸ¤”

å•é¡Œçš„é—œéµåœ¨æ–¼ï¼Œå°æ–¼ `add5` å’Œ `add10` é€™å…©å€‹å‡½æ•¸è€Œè¨€ï¼Œ`x` çš„å€¼æ˜¯ä»€éº¼ï¼Ÿä»–å€‘çœ‹åˆ°çš„æ˜¯ç›¸åŒçš„ `x`ï¼Ÿé‚„æ˜¯ä¸åŒçš„ `x`ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼šå° `add5` è€Œè¨€ï¼Œ`x` ç­‰æ–¼ 5ï¼›å° `add10` è€Œè¨€ï¼Œ`x` ç­‰æ–¼ 10ã€‚

ç†ç”±æ˜¯å› ç‚ºé€™å€‹ç‰¹æ€§ï¼š

> **æ¯ç•¶å‡½å¼è¢«å‘¼å«æ™‚ï¼Œéƒ½æœƒç”¢ç”Ÿä¸€çµ„æ–°çš„èªå½™ç’°å¢ƒ (Lexical Environment)ã€‚**

ä»¥ä¸Šé¢çš„ä¾‹å­è€Œè¨€ï¼Œå‘¼å«äº†å…©æ¬¡çš„ `makeAdder()`ï¼Œä¸€å…±ç”¢ç”Ÿäº†å…©çµ„ç’°å¢ƒã€‚

å‘¼å« `makeAdder(5)` çš„æ™‚å€™ï¼Œå‰µé€ äº†ä¸€çµ„ `x` ç­‰æ–¼ 5 çš„ç’°å¢ƒï¼Œä¸¦ä¸”å°‡å›å‚³çµæœæŒ‡å®šçµ¦ `add5`ã€‚

å› ç‚º closure çš„ç‰¹æ€§ï¼Œå‡½å¼ `add5` èƒ½å¤ å­˜å–é€™çµ„ `x` ç­‰æ–¼ 5 çš„ç’°å¢ƒï¼Œå› æ­¤çœ‹åˆ°çš„ `x` ç­‰æ–¼ 5ã€‚

å‘¼å« `makeAdder(10)` çš„æ™‚å€™ï¼Œå‰µé€ äº†å¦ä¸€çµ„ `x` ç­‰æ–¼ 10 çš„ç’°å¢ƒï¼Œä¸¦ä¸”å°‡å›å‚³çµæœæŒ‡å®šçµ¦ `add10`ã€‚

åŒç†ï¼Œå‡½å¼ `add10` çœ‹åˆ°çš„ `x` ç­‰æ–¼ 10ã€‚

ç¸½è€Œè¨€ä¹‹ï¼Œ`add5` å’Œ `add10` çœ‹åˆ°çš„ `x` è®Šæ•¸åœ¨è¨˜æ†¶é«”ä¸­æ˜¯ä¸ä¸€æ¨£çš„å…©å€‹è®Šæ•¸ã€‚

### å°çµ

æ­å–œä½ ï¼çœ‹åˆ°é€™è£¡ï¼Œä½ æ‡‰è©²èƒ½å¤ å¤§è‡´äº†è§£ closure çš„ç‰¹æ€§äº†ï¼

åœ¨ JavaScript ä¸­ï¼Œclosure å…¶å¯¦æœ‰å¾ˆå¤šæ‡‰ç”¨ï¼Œä¸‹é¢æˆ‘å€‘å°±ä¾†çœ‹çœ‹ä¸€äº› closure æ‡‰ç”¨çš„ç¯„ä¾‹å§ï¼

## é–‰åŒ… (Closure) çš„æ‡‰ç”¨

é–‰åŒ… (closure) åœ¨æ¯”è¼ƒé«˜å±¤æ¬¡çš„æ¦‚å¿µä¸Šï¼Œå¯ä»¥æƒ³æˆæŠŠå‡½å¼å’Œä¸€çµ„è³‡æ–™é—œè¯èµ·ä¾†ã€‚

é€™å°æ‡‰åˆ°ç‰©ä»¶å°å‘ç¨‹å¼è¨­è¨ˆ (Object-Oriented Programming) ä¸­ï¼Œç‰©ä»¶æ–¹æ³•å¯ä»¥å­˜å–ç‰©ä»¶å±¬æ€§ (property) çš„ç‰¹æ€§ã€‚

ä¸‹é¢æˆ‘å€‘å°±ä¾†çœ‹å¹¾å€‹ç°¡å–®çš„æ‡‰ç”¨ï¼š

### ç”¨é–‰åŒ… (Closure) æ¨¡æ“¬ç‰©ä»¶å°å‘ä¸­çš„ç§æœ‰æˆå“¡ (Private Member)

æˆ‘å€‘å¯ä»¥ç”¨ closure çš„ç‰¹æ€§ï¼Œæ¨¡æ“¬ç‰©ä»¶å°å‘ä¸­çš„ç§æœ‰æˆå“¡ (private member)ã€‚é€™å€‹æ–¹æ³•æœ‰æ™‚åˆè¢«ç¨±ä½œ Module Patternã€‚

ä¸‹é¢é€™å€‹ç¯„ä¾‹ï¼Œæˆ‘å€‘å‰µé€ ä¸€å€‹ `counter` ç‰©ä»¶ï¼Œä¸¦æä¾›ä¸‰å€‹æ–¹æ³•å­˜å–ç‰©ä»¶å…§éƒ¨çš„ `count` è®Šæ•¸ã€‚

```Javascript
function makeCounter() {
  let count = 0;
  function changeBy(val) {
    count += val;
  }

  return {
    increment: function() {
      changeBy(1)
    },
    decrement: function() {
      changeBy(-1)
    },
    value: function() {
      return count
    }
  };
};

const counter = makeCounter();

console.log(counter.value()); // 0
counter.increment();
counter.increment();
console.log(counter.value()); // 2
counter.decrement();
console.log(counter.value()); // 1
```

å› ç‚º closure çš„ç‰¹æ€§ï¼Œ`counter` ç‰©ä»¶çš„ä¸‰å€‹æ–¹æ³• `increment()`ã€`decrement()` å’Œ `value()` èƒ½å¤ å­˜å–åŒä¸€å€‹èªå½™ç’°å¢ƒ (Lexical Environment)ï¼Œæ‰€ä»¥é€™ä¸‰å€‹æ–¹æ³•èƒ½å¤ å­˜å– `makeCounter()` ä¸­çš„åŒä¸€å€‹ `count` è®Šæ•¸åŠ `changeBy()` å‡½å¼ã€‚

é€éå‘¼å«é€™ä¸‰å€‹æ–¹æ³•ï¼Œæˆ‘å€‘èƒ½å¤ æ”¹è®Šæˆ–è®€å–éš±è—èµ·ä¾†çš„ `count` è®Šæ•¸ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé™¤éé€é `counter` ç‰©ä»¶ä¸Šçš„ `increment()`ã€`decrement()` æˆ– `value()` æ–¹æ³•ï¼Œæˆ‘å€‘æ²’è¾¦æ³•ç›´æ¥å­˜å–å…¶å…§éƒ¨çš„ `count` è®Šæ•¸ã€‚å› æ­¤é€™è£çš„ `count` å°±ç›¸ç•¶æ–¼ç‰©ä»¶å°å‘ä¸­çš„ç§æœ‰æˆå“¡è®Šæ•¸ (private member)ã€‚

ä¸åƒ…å¦‚æ­¤ï¼Œclosure é‚„èƒ½å¤ é”åˆ°è³‡æ–™éš”é›¢çš„æ•ˆæœã€‚

å»¶çºŒä¸Šå€‹ä¾‹å­ï¼Œé€™è£¡åˆ©ç”¨ `makeCounter()` å‡½å¼ç”¢ç”Ÿäº†å…©å€‹ç‰©ä»¶ `counter1` å’Œ `counter2`:

```Javascript
const counter1 = makeCount();
const counter2 = makeCount();

counter1.increment();
counter1.increment();

counter2.decrement();

counter1.value(); // 2
counter2.value(); // -1
```

å› ç‚ºæ¯æ¬¡å‘¼å« `makeCounter()` æ™‚éƒ½æœƒç”¢ç”Ÿæ–°çš„ä¸€çµ„ç’°å¢ƒï¼Œæ‰€ä»¥ `counter1` å’Œ `counter2` æ“æœ‰å„è‡ªçš„ `count` è®Šæ•¸ï¼Œä¸æœƒäº’ç›¸å¹²æ“¾ï¼Œé”åˆ°è³‡æ–™äº’ç›¸éš”é›¢çš„æ•ˆæœã€‚

### åˆ©ç”¨ IIFE (Immediately Invoked Function Expression) ç”¢ç”Ÿç¨ç«‹çš„ç’°å¢ƒ

ä»¥ä¸‹æ˜¯ä¸€é¡Œå¾ˆç¶“å…¸çš„ JavaScript closure é¢è©¦é¡Œï¼š

> è«‹å•ä»¥ä¸‹é€™æ®µ code æœƒå°å‡ºä»€éº¼å€¼å‘¢ï¼Ÿ

```Javascript
for (var i = 0; i < 5; ++i) {
  setTimeout(function() {
    console.log(i)
  }, 1000 * i)
}
```

ä½ å¯èƒ½æœƒå¾ˆç›´è¦ºåœ°è¦ºå¾—æ˜¯æ¯éš”ä¸€ç§’å°å‡ºä¸€å€‹æ•¸å­—ï¼Œç¬¬ä¸€ç§’å°å‡º `0`ï¼Œç¬¬äºŒç§’å°å‡º `1`ï¼Œä»¥æ­¤é¡æ¨ï¼Œæœ€å¾Œå°å‡º `0 1 2 3 4`ã€‚

å¾ˆéºæ†¾ï¼Œé€™æ®µ code ä¸¦ä¸æœƒå¦‚ä½ æƒ³çš„é‹è¡Œã€‚é€™æ®µ code å¯¦éš›ä¸Šæœƒå°å‡º `5 5 5 5 5`ã€‚

ç‚ºä»€éº¼å‘¢ï¼Ÿä¸‹é¢è®“æˆ‘ä¾†èªªæ˜ï¼š

<!-- TODO: JavaScript çš„ scope åˆ°åº•æ˜¯æ€éº¼ä¸€å›äº‹ï¼Ÿ hoisting åˆæ˜¯ä»€éº¼ï¼Ÿ -->
<!-- Scope è·Ÿ Lexical Environment çš„é—œä¿‚æ˜¯ä»€éº¼ï¼Ÿ å¯ä»¥é€™æ¨£æ··è‘—ç”¨å—ï¼Ÿ -->

é¦–å…ˆ `var` å®£å‘Šçš„è®Šæ•¸æ˜¯ä»¥å‡½å¼ä½œç‚º scopeï¼Œæ‰€ä»¥è®Šæ•¸ `i` å¯ä»¥çœ‹æˆæ˜¯å…¨åŸŸè®Šæ•¸ã€‚ä¸Šé¢é‚£æ¨£çš„å¯«æ³•å¯¦éš›ä¸Šç­‰æ–¼ï¼š

```Javascript
var i; // A global variable!
for (i = 0; i < 5; ++i) {
  setTimeout(function() {
    console.log(i)
  }, 1000 * i)
}
```

é€™æ®µç¨‹å¼ç¢¼ç¸½å…±æœƒç”¢ç”Ÿäº”å€‹ callback å‡½å¼ï¼Œå› ç‚º closure çš„ç‰¹æ€§ï¼Œå®ƒå€‘éƒ½æœƒå­˜å–åˆ° global scope ä¸­çš„åŒä¸€å€‹è®Šæ•¸ `i`ã€‚

ç•¶è·‘å®Œ for è¿´åœˆå¾Œï¼Œ`i` ç­‰æ–¼ 5ã€‚

æ¥è‘—æ¯éš”ä¸€ç§’æœƒæœ‰ä¸€å€‹ callback è¢«å‘¼å«åˆ°ã€‚ç•¶ callback å¯¦éš›è¢«å‘¼å«åˆ°æ™‚ï¼Œæ‰æœƒå»çœ‹ `i` å¯¦éš›çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ 5ï¼Œæ‰€ä»¥æ‰æœƒå°å‡º 5 5 5 5 5ã€‚

ç¾åœ¨æˆ‘å€‘å·²ç¶“çŸ¥é“ä¸Šé¢çš„å¯«æ³•æœ‰å•é¡Œï¼Œé‚£æˆ‘å€‘åˆ°åº•è©²æ€éº¼å¯«æ‰å°å‘¢ï¼Ÿ

é—œéµæ˜¯ï¼šæˆ‘å€‘éœ€è¦è®“æ¯å€‹ callback éƒ½å¯ä»¥æœ‰å„è‡ªçš„è®Šæ•¸ `i`ã€‚ä¹Ÿå°±æ˜¯å°ç¬¬ä¸€å€‹ callback ä¾†èªªï¼Œè®Šæ•¸ `i` è¦ç­‰æ–¼ 0ï¼›å°ç¬¬äºŒå€‹ callback è®Šæ•¸ä¾†èªªï¼Œ`i` è¦ç­‰æ–¼ 1ï¼Œä»¥æ­¤é¡æ¨ã€‚

é€™è£æˆ‘å€‘å¯ä»¥é‹ç”¨ closure çš„ç‰¹æ€§ï¼Œè®“æ¯å€‹ callback å‡½æ•¸éƒ½æœ‰å„è‡ªçš„ç’°å¢ƒã€‚**é—œéµåœ¨æ–¼æˆ‘å€‘è¦æŠŠ callback ç”¨ä¸€å€‹ function åŒ…èµ·ä¾†ã€‚**

ä¸‹é¢åˆ—èˆ‰äº†å¹¾ç¨®å¯èƒ½çš„è§£æ³•ï¼š

#### 1. ç”¨ IIFE (Immediately Invoked Function Expression) æŠŠç¨‹å¼ç¢¼åŒ…èµ·ä¾†åŸ·è¡Œ

<!-- TODO: è§£é‡‹ä¸€ä¸‹ä»€éº¼æ˜¯ IIFE? -->

<!-- TODO: èªªæ˜ç‚ºä»€éº¼ IIFE èƒ½å¤ ç”¢ç”Ÿæ–°ç’°å¢ƒ -->

ç¬¬ä¸€ç¨®æ–¹æ³•æ˜¯ï¼šæŠŠæ•´æ®µ `setTimeout()` çš„ç¨‹å¼ç¢¼åŒ…åœ¨ IIFE ä¸­å»åŸ·è¡Œã€‚

```Javascript
for (var i = 0; i < 5; ++i) {
  (function(j) {
    setTimeout(function() {
      console.log(j)
    }, 1000 * j)
  })(i);
}
```

for è¿´åœˆçš„æ¯å€‹ iteration ä¸­ï¼Œcallback éƒ½æœƒè¢«åŒ…åœ¨ä¸€å€‹æ–°çš„ IIFE ä¸­ï¼Œæ¯å€‹ IIFE éƒ½æ˜¯ä¸€çµ„ç¨ç«‹çš„ç’°å¢ƒã€‚

å‘¼å« IIFE æ™‚ï¼Œæœƒå°‡ `i` çš„å€¼è¤‡è£½çµ¦ `j`ï¼Œå› æ­¤æ¯å€‹ IIFE éƒ½æœƒä¿å­˜å„è‡ªçš„è®Šæ•¸ `j`ã€‚

å› ç‚º closure çš„é—œä¿‚ï¼Œæ¯å€‹ callback éƒ½å¯ä»¥å­˜å–åˆ° IIFE ä¸­çš„è®Šæ•¸ `j`ï¼Œä¸¦ä¸”ä¸åŒ callback å­˜å–åˆ°çš„è®Šæ•¸ `j` éƒ½æ˜¯å„è‡ªç¨ç«‹çš„è®Šæ•¸ã€‚

å¦ä¸€ç¨®æ–¹æ³•æ˜¯ï¼šç”¨ IIFE ç”¢ç”Ÿä¸€å€‹ callback å‡½æ•¸ã€‚

```Javascript
for (var i = 0; i < 5; ++i) {
  setTimeout((function(j) {
    return function() {
      console.log(j)
    }
  })(i), 1000 * i)
}
```

é€™è£çš„ IIFE å›å‚³äº†æˆ‘å€‘éœ€è¦è®“ `setTimeout()` åŸ·è¡Œçš„ callbackã€‚

åŸç†å’Œå‰ä¸€å€‹ç¯„ä¾‹ç›¸åŒï¼Œéƒ½æ˜¯åˆ©ç”¨ IIFE åœ¨ for è¿´åœˆçš„æ¯å€‹ iteration ç”¢ç”Ÿä¸€çµ„æ–°çš„ç’°å¢ƒã€‚

#### 2. ç”¨ let

ä¸Šé¢æ˜¯æ¯”è¼ƒå‚³çµ±çš„å¯«æ³•ï¼Œå¦‚æœæ²’æœ‰ç¡¬è¦ç”¨ IIFE è§£æ±ºé€™å€‹å•é¡Œçš„è©±ï¼Œå…¶å¯¦ç”¨ `let` è§£æ±ºæ˜¯æœ€æ–¹ä¾¿å¿«é€Ÿçš„ï¼š

```Javascript
for (let i = 0; i < 5; ++i) {
  setTimeout(function() {
    console.log(i)
  }, 1000 * i)
}
```

å› ç‚ºå° `let` è€Œè¨€ï¼Œæ¯å€‹ for è¿´åœˆä¸­çš„ iteration éƒ½æ˜¯ä¸€å€‹ç¨ç«‹çš„ç’°å¢ƒï¼Œæ‰€ä»¥å¾ˆè‡ªç„¶åœ°æ¯å€‹ `setTimeout()` çš„ callback çœ‹åˆ°çš„ `i` æ˜¯ä¸åŒçš„ `i`ã€‚

## Lexical Environment (èªå½™ç’°å¢ƒ)

å‰é¢ä¸€ç›´æåˆ°èªå½™ç’°å¢ƒ (Lexical Environment) é€™å€‹è©å½™ï¼Œé€™é‚Šç¨åŠ è£œå……èªªæ˜ã€‚

JavaScript ä¸­ï¼Œæ¯æ®µå‡½æ•¸åŠå€å¡Š (code blockï¼Œä¹Ÿå°±æ˜¯å¤§æ‹¬è™Ÿ `{}` åœèµ·ä¾†çš„ç¯„åœ) éƒ½æœƒå°æ‡‰åˆ°ä¸€å€‹ç¨±ç‚º Lexical Environment (èªå½™ç’°å¢ƒ) çš„è³‡æ–™çµæ§‹ã€‚

Lexical Environment åŒ…å«äº†ä»¥ä¸‹å…©å€‹éƒ¨åˆ†ï¼š

1. Environment Recordï¼šå„²å­˜äº†æ‰€æœ‰çš„å€åŸŸè®Šæ•¸ã€‚
2. å¤–å±¤çš„ Lexical Environment çš„åƒè€ƒã€‚

<!-- æ¥ä¸‹ä¾†æœƒç”¨ä¸€äº›ä¾‹å­å¸¶å¤§å®¶çœ‹ Lexical Environment æ˜¯æ€éº¼é‹ä½œçš„ã€‚

ä¸‹é¢é€™å€‹ä¾‹å­åœ¨ global çš„ç’°å¢ƒä¸­ç°¡å–®åœ°å®£å‘Šäº†ä¸€å€‹è®Šæ•¸ `name`ã€‚

```JavaScript
                  // [[ name: <uninitialized> ]] -> null
let name;         // [[ name: undefined       ]] -> null
name = "John";    // [[ name: "John"          ]] -> null
```

`[[ ]]` çš„éƒ¨åˆ†æŒ‡çš„æ˜¯ Environment Recordï¼›ç®­é ­çš„éƒ¨åˆ†æ˜¯æŒ‡å‘å¤–å±¤çš„ Lexical Environmentã€‚

é€™è£åªæœ‰ä¸€å€‹ Lexical Environmentï¼Œä¹Ÿå°±æ˜¯ "global" Lexical Environmentã€‚å› ç‚º Global Lexical Environment å·²ç¶“æ˜¯æœ€å¤–å±¤äº†ï¼Œæ‰€ä»¥å…¶å¤–å±¤çš„ Lexical Environment æ˜¯ `null`ã€‚

ç•¶æˆ‘å€‘å‰µé€ æˆ–ä¿®æ”¹ä¸€å€‹è®Šæ•¸æ™‚ï¼Œå…¶å¯¦å°±æ˜¯åœ¨æ–°å¢æˆ–æ˜¯ä¿®æ”¹ enviromental record çš„å±¬æ€§ã€‚

é€™é‚Šä¸€æ­¥æ­¥è§£é‡‹ä¸Šé¢é€™æ®µ code æ€éº¼é‹ä½œã€‚

1. é¦–å…ˆ script é–‹å§‹åŸ·è¡Œæ™‚ï¼ŒLexical Environment è¢«å‰µé€ å‡ºä¾†ä¸”åŒ…å«äº†æ‰€æœ‰è¢«å®£å‘Šçš„è®Šæ•¸ï¼Œä¹Ÿå°±æ˜¯é€™è£çš„ `name` è®Šæ•¸ï¼Œä½†å› ç‚ºé‚„æ²’å®£å‘Šï¼Œæ‰€ä»¥è™•æ–¼ä¸€å€‹ç‰¹åˆ¥çš„ uninitialized ç‹€æ…‹ã€‚
2. æˆ‘å€‘å®£å‘Š `let name;`ï¼Œæ­¤æ™‚ `name` çš„å€¼ç‚º `undefined`ã€‚
3. æˆ‘å€‘æŠŠä¸€å€‹å€¼æŒ‡å®šçµ¦ `name` è®Šæ•¸ã€‚ -->

<!-- TODO: function å¦‚ä½•é‹ä½œ -->

ä¸€æ®µ code è¦å­˜å–ä¸€å€‹è®Šæ•¸çš„æ™‚å€™ï¼Œæœƒå…ˆåœ¨è‡ªå·±çš„ environment record è£¡é¢æ‰¾ï¼Œæ‰¾ä¸åˆ°æœƒå†å¾€å¤–å±¤çš„ Lexical Environment æ‰¾ï¼Œç›´åˆ° global Lexical Environment ç‚ºæ­¢ã€‚

**é€™å°±æ˜¯å…§å±¤çš„ function èƒ½å¤ å­˜å–å®£å‘Šåœ¨å¤–å±¤çš„è®Šæ•¸çš„åŸç†ã€‚**

## Reference

[Closures - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures)

[Closure - javascript.info](http://javascript.info/closure)
